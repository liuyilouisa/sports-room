import{Q as Me,i as le,h as je,f as we,g as Ne,r as q,c as ce,j as r,k as ve,l as _e,e as Se,a as De,d as Ye,L as Ce}from"./index-BUS16Z0V.js";import{o as se,n as E,s as ie,h as Oe,l as Ie,i as ye,u as Pe,a as ke,b as ne}from"./schemas-BYk0niwe.js";import{S as ae,E as Le,g as Re}from"./Empty-BjX3nvmc.js";import{c as Te}from"./order-C01BSQfb.js";import{O as Ee,V as U}from"./index-G2bsMOGr.js";var Ae=class extends Me{constructor(e,i){super(e,i)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e){super.setOptions({...e,behavior:le()})}getOptimisticResult(e){return e.behavior=le(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,i){const{state:c}=e,m=super.createResult(e,i),{isFetching:p,isRefetching:y,isError:a,isRefetchError:d}=m,x=c.fetchMeta?.fetchMore?.direction,l=a&&x==="forward",b=p&&x==="forward",g=a&&x==="backward",D=p&&x==="backward";return{...m,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:we(i,c.data),hasPreviousPage:je(i,c.data),isFetchNextPageError:l,isFetchingNextPage:b,isFetchPreviousPageError:g,isFetchingPreviousPage:D,isRefetchError:d&&!l&&!g,isRefetching:y&&!b&&!D}}};function Fe(e,i){return Ne(e,Ae)}var oe=new Map,G=new WeakMap,he=0,He=void 0;function qe(e){return e?(G.has(e)||(he+=1,G.set(e,he.toString())),G.get(e)):"0"}function Qe(e){return Object.keys(e).sort().filter(i=>e[i]!==void 0).map(i=>`${i}_${i==="root"?qe(e.root):e[i]}`).toString()}function ze(e){const i=Qe(e);let c=oe.get(i);if(!c){const m=new Map;let p;const y=new IntersectionObserver(a=>{a.forEach(d=>{var x;const l=d.isIntersecting&&p.some(b=>d.intersectionRatio>=b);e.trackVisibility&&typeof d.isVisible>"u"&&(d.isVisible=l),(x=m.get(d.target))==null||x.forEach(b=>{b(l,d)})})},e);p=y.thresholds||(Array.isArray(e.threshold)?e.threshold:[e.threshold||0]),c={id:i,observer:y,elements:m},oe.set(i,c)}return c}function Ve(e,i,c={},m=He){if(typeof window.IntersectionObserver>"u"&&m!==void 0){const x=e.getBoundingClientRect();return i(m,{isIntersecting:m,target:e,intersectionRatio:typeof c.threshold=="number"?c.threshold:0,time:0,boundingClientRect:x,intersectionRect:x,rootBounds:x}),()=>{}}const{id:p,observer:y,elements:a}=ze(c),d=a.get(e)||[];return a.has(e)||a.set(e,d),d.push(i),y.observe(e),function(){d.splice(d.indexOf(i),1),d.length===0&&(a.delete(e),y.unobserve(e)),a.size===0&&(y.disconnect(),oe.delete(p))}}function We({threshold:e,delay:i,trackVisibility:c,rootMargin:m,root:p,triggerOnce:y,skip:a,initialInView:d,fallbackInView:x,onChange:l}={}){var b;const[g,D]=q.useState(null),N=q.useRef(l),[w,L]=q.useState({inView:!!d,entry:void 0});N.current=l,q.useEffect(()=>{if(a||!g)return;let P;return P=Ve(g,(v,$)=>{L({inView:v,entry:$}),N.current&&N.current(v,$),$.isIntersecting&&y&&P&&(P(),P=void 0)},{root:p,rootMargin:m,threshold:e,trackVisibility:c,delay:i},x),()=>{P&&P()}},[Array.isArray(e)?e.toString():e,g,p,m,y,a,c,x,i]);const A=(b=w.entry)==null?void 0:b.target,R=q.useRef(void 0);!g&&A&&!y&&!a&&R.current!==A&&(R.current=A,L({inView:!!d,entry:void 0}));const I=[D,w.inView,w.entry];return I.ref=I[0],I.inView=I[1],I.entry=I[2],I}function Be(e,i){return ce.post(`/api/activities/${e}/comments`,i)}function Ke(e,i={}){return ce.get(`/api/activities/${e}/comments`,{params:i})}function Ue(e,i){return ce.delete(`/api/activities/${e}/comments/${i}`)}const Ze=se({content:ie().min(1,{message:"内容不能为空"}).max(500,{message:"内容不能超过500字符"}),activityId:E().int().positive(),parentId:E().int().positive().optional()});se({page:E().int().min(1).default(1),size:E().int().min(1).max(100).default(20)});const Je=se({id:E(),content:ie(),parentId:E().nullable(),userId:E(),userName:ie(),createdAt:Oe(),activityId:E()}),ge=Je.extend({children:Ie(()=>ye(ge)).optional()});se({list:ye(ge),total:E(),page:E(),size:E()});const pe=({activityId:e,parentId:i,onSubmit:c,onCancel:m,placeholder:p="写下你的评论…"})=>{const{register:y,handleSubmit:a,reset:d,watch:x,formState:{errors:l,isSubmitting:b}}=Pe({resolver:ke(Ze.omit({activityId:!0,parentId:!0}).extend({parentId:E().optional()})),defaultValues:{parentId:i}}),g=x("content"),D=g?.length>500,N=async w=>{await c(w),d()};return r.jsxs("form",{onSubmit:a(N),className:"space-y-2",children:[r.jsx("textarea",{...y("content"),rows:3,placeholder:p,className:"w-full rounded border border-gray-300 p-2 text-sm focus:border-blue-500 focus:outline-none"}),l.content&&r.jsx("p",{className:"text-xs text-red-500",children:l.content.message}),r.jsxs("div",{className:"flex items-center justify-end gap-2",children:[m&&r.jsx("button",{type:"button",onClick:m,className:"text-sm text-gray-500 hover:text-gray-800",children:"取消"}),r.jsxs("button",{type:"submit",disabled:b||D||!g?.trim(),className:"flex items-center gap-1 rounded bg-blue-600 px-3 py-1.5 text-sm text-white hover:bg-blue-700 disabled:opacity-60",children:[b&&r.jsx(ae,{size:"xs"}),b?"发表中…":"发表"]})]})]})};var ee={exports:{}},Xe=ee.exports,fe;function be(){return fe||(fe=1,function(e,i){(function(c,m){e.exports=m()})(Xe,function(){var c=1e3,m=6e4,p=36e5,y="millisecond",a="second",d="minute",x="hour",l="day",b="week",g="month",D="quarter",N="year",w="date",L="Invalid Date",A=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,R=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,I={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(u){var n=["th","st","nd","rd"],t=u%100;return"["+u+(n[(t-20)%10]||n[t]||n[0])+"]"}},P=function(u,n,t){var o=String(u);return!o||o.length>=n?u:""+Array(n+1-o.length).join(t)+u},v={s:P,z:function(u){var n=-u.utcOffset(),t=Math.abs(n),o=Math.floor(t/60),s=t%60;return(n<=0?"+":"-")+P(o,2,"0")+":"+P(s,2,"0")},m:function u(n,t){if(n.date()<t.date())return-u(t,n);var o=12*(t.year()-n.year())+(t.month()-n.month()),s=n.clone().add(o,g),h=t-s<0,f=n.clone().add(o+(h?-1:1),g);return+(-(o+(t-s)/(h?s-f:f-s))||0)},a:function(u){return u<0?Math.ceil(u)||0:Math.floor(u)},p:function(u){return{M:g,y:N,w:b,d:l,D:w,h:x,m:d,s:a,ms:y,Q:D}[u]||String(u||"").toLowerCase().replace(/s$/,"")},u:function(u){return u===void 0}},$="en",_={};_[$]=I;var F="$isDayjsObject",H=function(u){return u instanceof J||!(!u||!u[F])},Z=function u(n,t,o){var s;if(!n)return $;if(typeof n=="string"){var h=n.toLowerCase();_[h]&&(s=h),t&&(_[h]=t,s=h);var f=n.split("-");if(!s&&f.length>1)return u(f[0])}else{var j=n.name;_[j]=n,s=j}return!o&&s&&($=s),s||!o&&$},Y=function(u,n){if(H(u))return u.clone();var t=typeof n=="object"?n:{};return t.date=u,t.args=arguments,new J(t)},M=v;M.l=Z,M.i=H,M.w=function(u,n){return Y(u,{locale:n.$L,utc:n.$u,x:n.$x,$offset:n.$offset})};var J=function(){function u(t){this.$L=Z(t.locale,null,!0),this.parse(t),this.$x=this.$x||t.x||{},this[F]=!0}var n=u.prototype;return n.parse=function(t){this.$d=function(o){var s=o.date,h=o.utc;if(s===null)return new Date(NaN);if(M.u(s))return new Date;if(s instanceof Date)return new Date(s);if(typeof s=="string"&&!/Z$/i.test(s)){var f=s.match(A);if(f){var j=f[2]-1||0,S=(f[7]||"0").substring(0,3);return h?new Date(Date.UTC(f[1],j,f[3]||1,f[4]||0,f[5]||0,f[6]||0,S)):new Date(f[1],j,f[3]||1,f[4]||0,f[5]||0,f[6]||0,S)}}return new Date(s)}(t),this.init()},n.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},n.$utils=function(){return M},n.isValid=function(){return this.$d.toString()!==L},n.isSame=function(t,o){var s=Y(t);return this.startOf(o)<=s&&s<=this.endOf(o)},n.isAfter=function(t,o){return Y(t)<this.startOf(o)},n.isBefore=function(t,o){return this.endOf(o)<Y(t)},n.$g=function(t,o,s){return M.u(t)?this[o]:this.set(s,t)},n.unix=function(){return Math.floor(this.valueOf()/1e3)},n.valueOf=function(){return this.$d.getTime()},n.startOf=function(t,o){var s=this,h=!!M.u(o)||o,f=M.p(t),j=function(V,k){var Q=M.w(s.$u?Date.UTC(s.$y,k,V):new Date(s.$y,k,V),s);return h?Q:Q.endOf(l)},S=function(V,k){return M.w(s.toDate()[V].apply(s.toDate("s"),(h?[0,0,0,0]:[23,59,59,999]).slice(k)),s)},C=this.$W,O=this.$M,T=this.$D,W="set"+(this.$u?"UTC":"");switch(f){case N:return h?j(1,0):j(31,11);case g:return h?j(1,O):j(0,O+1);case b:var z=this.$locale().weekStart||0,B=(C<z?C+7:C)-z;return j(h?T-B:T+(6-B),O);case l:case w:return S(W+"Hours",0);case x:return S(W+"Minutes",1);case d:return S(W+"Seconds",2);case a:return S(W+"Milliseconds",3);default:return this.clone()}},n.endOf=function(t){return this.startOf(t,!1)},n.$set=function(t,o){var s,h=M.p(t),f="set"+(this.$u?"UTC":""),j=(s={},s[l]=f+"Date",s[w]=f+"Date",s[g]=f+"Month",s[N]=f+"FullYear",s[x]=f+"Hours",s[d]=f+"Minutes",s[a]=f+"Seconds",s[y]=f+"Milliseconds",s)[h],S=h===l?this.$D+(o-this.$W):o;if(h===g||h===N){var C=this.clone().set(w,1);C.$d[j](S),C.init(),this.$d=C.set(w,Math.min(this.$D,C.daysInMonth())).$d}else j&&this.$d[j](S);return this.init(),this},n.set=function(t,o){return this.clone().$set(t,o)},n.get=function(t){return this[M.p(t)]()},n.add=function(t,o){var s,h=this;t=Number(t);var f=M.p(o),j=function(O){var T=Y(h);return M.w(T.date(T.date()+Math.round(O*t)),h)};if(f===g)return this.set(g,this.$M+t);if(f===N)return this.set(N,this.$y+t);if(f===l)return j(1);if(f===b)return j(7);var S=(s={},s[d]=m,s[x]=p,s[a]=c,s)[f]||1,C=this.$d.getTime()+t*S;return M.w(C,this)},n.subtract=function(t,o){return this.add(-1*t,o)},n.format=function(t){var o=this,s=this.$locale();if(!this.isValid())return s.invalidDate||L;var h=t||"YYYY-MM-DDTHH:mm:ssZ",f=M.z(this),j=this.$H,S=this.$m,C=this.$M,O=s.weekdays,T=s.months,W=s.meridiem,z=function(k,Q,K,X){return k&&(k[Q]||k(o,h))||K[Q].slice(0,X)},B=function(k){return M.s(j%12||12,k,"0")},V=W||function(k,Q,K){var X=k<12?"AM":"PM";return K?X.toLowerCase():X};return h.replace(R,function(k,Q){return Q||function(K){switch(K){case"YY":return String(o.$y).slice(-2);case"YYYY":return M.s(o.$y,4,"0");case"M":return C+1;case"MM":return M.s(C+1,2,"0");case"MMM":return z(s.monthsShort,C,T,3);case"MMMM":return z(T,C);case"D":return o.$D;case"DD":return M.s(o.$D,2,"0");case"d":return String(o.$W);case"dd":return z(s.weekdaysMin,o.$W,O,2);case"ddd":return z(s.weekdaysShort,o.$W,O,3);case"dddd":return O[o.$W];case"H":return String(j);case"HH":return M.s(j,2,"0");case"h":return B(1);case"hh":return B(2);case"a":return V(j,S,!0);case"A":return V(j,S,!1);case"m":return String(S);case"mm":return M.s(S,2,"0");case"s":return String(o.$s);case"ss":return M.s(o.$s,2,"0");case"SSS":return M.s(o.$ms,3,"0");case"Z":return f}return null}(k)||f.replace(":","")})},n.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},n.diff=function(t,o,s){var h,f=this,j=M.p(o),S=Y(t),C=(S.utcOffset()-this.utcOffset())*m,O=this-S,T=function(){return M.m(f,S)};switch(j){case N:h=T()/12;break;case g:h=T();break;case D:h=T()/3;break;case b:h=(O-C)/6048e5;break;case l:h=(O-C)/864e5;break;case x:h=O/p;break;case d:h=O/m;break;case a:h=O/c;break;default:h=O}return s?h:M.a(h)},n.daysInMonth=function(){return this.endOf(g).$D},n.$locale=function(){return _[this.$L]},n.locale=function(t,o){if(!t)return this.$L;var s=this.clone(),h=Z(t,o,!0);return h&&(s.$L=h),s},n.clone=function(){return M.w(this.$d,this)},n.toDate=function(){return new Date(this.valueOf())},n.toJSON=function(){return this.isValid()?this.toISOString():null},n.toISOString=function(){return this.$d.toISOString()},n.toString=function(){return this.$d.toUTCString()},u}(),de=J.prototype;return Y.prototype=de,[["$ms",y],["$s",a],["$m",d],["$H",x],["$W",l],["$M",g],["$y",N],["$D",w]].forEach(function(u){de[u[1]]=function(n){return this.$g(n,u[0],u[1])}}),Y.extend=function(u,n){return u.$i||(u(n,J,Y),u.$i=!0),Y},Y.locale=Z,Y.isDayjs=H,Y.unix=function(u){return Y(1e3*u)},Y.en=_[$],Y.Ls=_,Y.p={},Y})}(ee)),ee.exports}var Ge=be();const ue=ve(Ge);var te={exports:{}},et=te.exports,me;function tt(){return me||(me=1,function(e,i){(function(c,m){e.exports=m()})(et,function(){return function(c,m,p){c=c||{};var y=m.prototype,a={future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"};function d(l,b,g,D){return y.fromToBase(l,b,g,D)}p.en.relativeTime=a,y.fromToBase=function(l,b,g,D,N){for(var w,L,A,R=g.$locale().relativeTime||a,I=c.thresholds||[{l:"s",r:44,d:"second"},{l:"m",r:89},{l:"mm",r:44,d:"minute"},{l:"h",r:89},{l:"hh",r:21,d:"hour"},{l:"d",r:35},{l:"dd",r:25,d:"day"},{l:"M",r:45},{l:"MM",r:10,d:"month"},{l:"y",r:17},{l:"yy",d:"year"}],P=I.length,v=0;v<P;v+=1){var $=I[v];$.d&&(w=D?p(l).diff(g,$.d,!0):g.diff(l,$.d,!0));var _=(c.rounding||Math.round)(Math.abs(w));if(A=w>0,_<=$.r||!$.r){_<=1&&v>0&&($=I[v-1]);var F=R[$.l];N&&(_=N(""+_)),L=typeof F=="string"?F.replace("%d",_):F(_,b,$.l,A);break}}if(b)return L;var H=A?R.future:R.past;return typeof H=="function"?H(L):H.replace("%s",L)},y.to=function(l,b){return d(l,b,this,!0)},y.from=function(l,b){return d(l,b,this)};var x=function(l){return l.$u?p.utc():p()};y.toNow=function(l){return this.to(x(this),l)},y.fromNow=function(l){return this.from(x(this),l)}}})}(te)),te.exports}var rt=tt();const st=ve(rt);var re={exports:{}},nt=re.exports,xe;function it(){return xe||(xe=1,function(e,i){(function(c,m){e.exports=m(be())})(nt,function(c){function m(a){return a&&typeof a=="object"&&"default"in a?a:{default:a}}var p=m(c),y={name:"zh-cn",weekdays:"星期日_星期一_星期二_星期三_星期四_星期五_星期六".split("_"),weekdaysShort:"周日_周一_周二_周三_周四_周五_周六".split("_"),weekdaysMin:"日_一_二_三_四_五_六".split("_"),months:"一月_二月_三月_四月_五月_六月_七月_八月_九月_十月_十一月_十二月".split("_"),monthsShort:"1月_2月_3月_4月_5月_6月_7月_8月_9月_10月_11月_12月".split("_"),ordinal:function(a,d){return d==="W"?a+"周":a+"日"},weekStart:1,yearStart:4,formats:{LT:"HH:mm",LTS:"HH:mm:ss",L:"YYYY/MM/DD",LL:"YYYY年M月D日",LLL:"YYYY年M月D日Ah点mm分",LLLL:"YYYY年M月D日ddddAh点mm分",l:"YYYY/M/D",ll:"YYYY年M月D日",lll:"YYYY年M月D日 HH:mm",llll:"YYYY年M月D日dddd HH:mm"},relativeTime:{future:"%s内",past:"%s前",s:"几秒",m:"1 分钟",mm:"%d 分钟",h:"1 小时",hh:"%d 小时",d:"1 天",dd:"%d 天",M:"1 个月",MM:"%d 个月",y:"1 年",yy:"%d 年"},meridiem:function(a,d){var x=100*a+d;return x<600?"凌晨":x<900?"早上":x<1100?"上午":x<1300?"中午":x<1800?"下午":"晚上"}};return p.default.locale(y,null,!0),y})}(re)),re.exports}it();ue.locale("zh-cn");ue.extend(st);const at=10,$e=({comment:e,currentUserId:i,onDelete:c,onReply:m,depth:p=0})=>{const[y,a]=q.useState(!1),[d,x]=q.useState(!0),[l,b]=q.useState(!1),g=150,D=e.content.length>g,N=i===e.userId;return r.jsxs("div",{className:"flex space-x-3","data-testid":"comment-item",children:[r.jsx("div",{className:`flex-shrink-0 rounded-full bg-gray-200 flex-center text-sm font-bold text-gray-500
          ${p===0?"w-8 h-8":"w-6 h-6 text-xs"}`,children:e.userName.charAt(0)}),r.jsxs("div",{className:"flex-1",children:[r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("span",{className:"text-sm font-semibold",children:e.userName}),r.jsx("span",{className:"text-xs text-gray-400",children:ue(e.createdAt).fromNow()})]}),r.jsxs("p",{className:"mt-1 text-sm text-gray-800",children:[D&&!l?`${e.content.slice(0,g)}…`:e.content,D&&r.jsx("button",{onClick:()=>b(!l),className:"ml-1 text-blue-600 hover:underline text-xs",children:l?"收起":"展开"})]}),r.jsxs("div",{className:"mt-1 flex items-center gap-3 text-xs text-gray-500",children:[p<1&&r.jsx("button",{onClick:()=>a(!y),className:"hover:text-blue-600",children:"回复"}),N&&r.jsx("button",{onClick:()=>c(e.id),className:"hover:text-red-600",children:"删除"})]}),y&&r.jsx("div",{className:"mt-2",children:r.jsx(pe,{activityId:e.activityId,parentId:e.id,placeholder:`回复 ${e.userName}…`,onSubmit:({content:w})=>(a(!1),m({content:w,parentId:e.id})),onCancel:()=>a(!1)})}),e.children&&e.children.length>0&&r.jsxs("div",{className:`mt-4 space-y-4 border-l-2 pl-4
              ${p===0?"ml-0":""}`,children:[p===0&&e.children.length>at&&r.jsx("button",{onClick:()=>x(!d),className:"text-xs text-blue-600 underline",children:d?"收起回复":`展开 ${e.children.length} 条回复`}),d&&e.children.map(w=>r.jsx($e,{comment:w,currentUserId:i,onDelete:c,onReply:m,depth:p+1},w.id))]})]})]})},ot=({comments:e,total:i,currentUserId:c,loadingMore:m,onDelete:p,onReply:y,onLoadMore:a})=>e.length?r.jsxs("div",{className:"space-y-6",children:[r.jsxs("h3",{className:"text-lg font-semibold",children:["共 ",i," 条评论"]}),e.map(d=>r.jsx($e,{comment:d,currentUserId:c,onDelete:p,onReply:y},d.id)),a&&e.length<i&&r.jsx("div",{className:"text-center",children:r.jsx("button",{onClick:a,disabled:m,className:"text-sm text-blue-600 hover:underline disabled:opacity-50",children:m?"加载中…":"加载更多"})}),r.jsx("div",{"data-testid":"comment-list-end",style:{height:1}})]}):r.jsx(Le,{text:"暂无评论，快来抢沙发~"});function ft(){const{id:e}=_e(),i=Number(e),c=Se(),m=De(v=>v.user),{ref:p,inView:y}=We({threshold:.5}),{data:a,isLoading:d,isError:x,error:l}=Ye({queryKey:["activity",i],queryFn:()=>Re(i),enabled:!!e}),{data:b,isLoading:g,isFetchingNextPage:D,fetchNextPage:N,hasNextPage:w}=Fe({queryKey:["comments",i],queryFn:({pageParam:v=1})=>Ke(i,{page:v,size:20}).then($=>$.data),initialPageParam:1,getNextPageParam:v=>{const $=Math.ceil(v.total/20),_=v.page+1;return _<=$?_:void 0},enabled:!!e});q.useEffect(()=>{y&&w&&!D&&N()},[y,w,D,N]);const L=ne({mutationFn:v=>Be(v.activityId,v),onSuccess:()=>{c.invalidateQueries({queryKey:["comments",i]}),U.success("评论发表成功")},onError:()=>U.error("评论发表失败")}),A=ne({mutationFn:v=>Ue(v.activityId,v.commentId),onMutate:async v=>{await c.cancelQueries({queryKey:["comments",i]});const $=c.getQueryData(["comments",i]);return c.setQueryData(["comments",i],_=>_&&{..._,pages:_.pages.map(F=>({...F,data:F.data.filter(H=>H.id!==v.commentId)}))}),{prev:$}},onError:(v,$,_)=>{c.setQueryData(["comments",i],_?.prev),U.error("删除失败")},onSettled:()=>c.invalidateQueries({queryKey:["comments",i]})}),R=ne({mutationFn:()=>Te(i),onSuccess:()=>{c.invalidateQueries({queryKey:["activity",i]}),c.invalidateQueries({queryKey:["myOrders"]}),U.success("报名成功！")},onError:v=>{const $=v?.response?.status===409?v?.response?.data?.message||"名额已满或不符合报名条件":"报名失败";U.error($)}});if(d)return r.jsx("div",{className:"flex items-center justify-center min-h-screen",children:r.jsx(ae,{})});if(x)return r.jsx("div",{className:"text-red-500 p-10 flex items-center justify-center min-h-screen",children:r.jsx("span",{className:"bg-red-50 px-4 py-2 rounded-md shadow",children:String(l)})});if(!a)return r.jsx("div",{className:"text-gray-500 p-10 flex items-center justify-center min-h-screen",children:"活动不存在"});const I=b?.pages.flatMap(v=>v.data)??[],P=b?.pages[0]?.total??0;return r.jsxs(r.Fragment,{children:[r.jsx(Ee,{position:"top-center"}),r.jsx("div",{className:"min-h-screen bg-gradient-to-br from-slate-50 to-sky-50",children:r.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-10",children:[r.jsxs(Ce,{to:"/activities",className:"inline-flex items-center gap-1.5 mb-6 text-sm font-medium text-sky-600 hover:text-sky-700 transition",children:[r.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",strokeWidth:"2",viewBox:"0 0 24 24",children:r.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M15 19l-7-7 7-7"})}),"返回列表"]}),r.jsxs("div",{className:"bg-white rounded-2xl shadow-lg p-6 md:p-8",children:[r.jsx("h1",{className:"text-3xl md:text-4xl font-bold text-slate-900 mb-3",children:a.title}),r.jsx("p",{className:"text-slate-600 mb-6 leading-relaxed",children:a.description}),r.jsxs("div",{className:"space-y-4 divide-y divide-slate-100",children:[r.jsxs("div",{className:"flex items-center gap-3",children:[r.jsx("span",{className:"w-24 font-semibold text-slate-700",children:"开始时间"}),r.jsx("span",{className:"text-slate-500",children:new Date(a.startAt).toLocaleString("zh-CN")})]}),r.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[r.jsx("span",{className:"w-24 font-semibold text-slate-700",children:"结束时间"}),r.jsx("span",{className:"text-slate-500",children:a.endAt?new Date(a.endAt).toLocaleString("zh-CN"):"暂无"})]}),r.jsxs("div",{className:"flex items-center gap-3 pt-4",children:[r.jsx("span",{className:"w-24 font-semibold text-slate-700",children:"名额状态"}),r.jsxs("span",{className:"text-slate-500",children:[a.enrolledCount," /"," ",a.capacity]})]})]}),r.jsx("div",{className:"mt-8 flex justify-center",children:r.jsx("button",{onClick:()=>R.mutate(),disabled:R.isPending,className:"px-8 py-3 bg-gradient-to-r from-sky-500 to-sky-600 text-white font-semibold rounded-full shadow-lg hover:shadow-sky-400/50 hover:scale-105 disabled:from-gray-300 disabled:to-gray-400 disabled:shadow-none transition-all duration-200",children:R.isPending?"报名中...":"立即报名"})})]}),r.jsxs("section",{className:"mt-10",children:[r.jsx("h2",{className:"text-2xl font-bold text-slate-800 mb-6",children:"评论区"}),m?r.jsx(pe,{activityId:i,onSubmit:async({content:v,parentId:$})=>{await L.mutateAsync({activityId:i,content:v,parentId:$})}}):r.jsx("p",{className:"text-gray-500 mb-4",children:"请登录后评论"}),g?r.jsx(ae,{}):r.jsxs(r.Fragment,{children:[r.jsx(ot,{comments:I,total:P,currentUserId:m?.id,loadingMore:D,onDelete:async v=>{window.confirm("确认删除该评论？")&&await A.mutateAsync({activityId:i,commentId:v})},onReply:async({content:v,parentId:$})=>{await L.mutateAsync({activityId:i,content:v,parentId:$})},onLoadMore:w?()=>N():void 0}),r.jsx("div",{ref:p})]})]})]})})]})}export{ft as default};
