import{c as p,d as v,e as h,r as b,j as e}from"./index-BUS16Z0V.js";import{_ as g,c as w,Z as k,d as S,b as y,o as q,f as C,s as m,g as D,u as F,a as K}from"./schemas-BYk0niwe.js";import{O as Q,V as N}from"./index-G2bsMOGr.js";function $(t){return w(k,t)}function E(t){return g(S,t)}const L=t=>p.post("/api/admin/activities",t),V=(t=1,a=20)=>p.get("/api/admin/activities",{params:{page:t,size:a}}),_=(t,a)=>p.put(`/api/admin/activities/${t}`,a),Z=t=>p.delete(`/api/admin/activities/${t}`),O={list:(t,a)=>["admin-activities",t,a]},f=(t=1,a=20)=>v({queryKey:O.list(t,a),queryFn:()=>V(t,a).then(c=>c.data)}),P=()=>{const t=h();return y({mutationFn:L,onSuccess:()=>t.invalidateQueries({queryKey:["admin-activities"]})})},M=()=>{const t=h();return y({mutationFn:({id:a,data:c})=>_(a,c),onSuccess:()=>t.invalidateQueries({queryKey:["admin-activities"]})})},R=()=>{const t=h();return y({mutationFn:Z,onSuccess:()=>t.invalidateQueries({queryKey:["admin-activities"]})})},A=q({title:m().min(1,"标题不能为空"),description:m().min(1,"描述不能为空"),capacity:$().int().positive("人数必须为正整数"),startAt:m().min(1,"开始时间不能为空").pipe(E()),endAt:m().optional().transform(t=>t?new Date(t):null).pipe(D().nullable())}),U=A.partial().extend({status:C(["draft","published"]).optional()});function Y({activityId:t,onClose:a,onSubmit:c}){const o=r=>({title:r.title,description:r.description,capacity:r.capacity,startAt:r.startAt?.slice(0,16)??"",endAt:r.endAt?r.endAt.slice(0,16):""}),{data:u}=f(),n=u?.data?.find(r=>r.id===t),x=t?U:A,{register:i,handleSubmit:d,reset:s,formState:{errors:l,isSubmitting:j}}=F({resolver:K(x),defaultValues:n?o(n):{title:"",description:"",capacity:10,startAt:"",endAt:""}});return b.useEffect(()=>{n&&s(o(n))},[n,s]),e.jsx("div",{className:"fixed inset-0 bg-black/40 flex justify-center items-center z-20",onClick:a,children:e.jsxs("div",{className:"bg-white p-6 rounded w-full max-w-md",onClick:r=>r.stopPropagation(),children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:t?"编辑活动":"新建活动"}),e.jsxs("form",{onSubmit:d(c),children:[e.jsxs("label",{className:"block mb-2",children:["标题",e.jsx("input",{"aria-label":"标题",...i("title"),className:"block w-full border rounded px-2 py-1"}),l.title&&e.jsx("p",{className:"text-red-500 text-sm",children:l.title.message})]}),e.jsxs("label",{className:"block mb-2",children:["开始时间",e.jsx("input",{"aria-label":"开始时间",type:"datetime-local",...i("startAt"),className:"block w-full border rounded px-2 py-1"}),l.startAt&&e.jsx("p",{className:"text-red-500 text-sm",children:l.startAt.message})]}),e.jsxs("label",{className:"block mb-2",children:["结束时间（选填）",e.jsx("input",{"aria-label":"结束时间",type:"datetime-local",...i("endAt"),className:"block w-full border rounded px-2 py-1"}),l.endAt&&e.jsx("p",{className:"text-red-500 text-sm",children:l.endAt.message})]}),e.jsxs("label",{className:"block mb-2",children:["描述",e.jsx("textarea",{"aria-label":"描述",...i("description"),className:"block w-full border rounded px-2 py-1"}),l.description&&e.jsx("p",{className:"text-red-500 text-sm",children:l.description.message})]}),e.jsxs("label",{className:"block mb-4",children:["人数上限",e.jsx("input",{"aria-label":"人数上限",type:"number",...i("capacity",{valueAsNumber:!0}),className:"block w-full border rounded px-2 py-1"}),l.capacity&&e.jsx("p",{className:"text-red-500 text-sm",children:l.capacity.message})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{"aria-label":"取消",type:"button",className:"px-4 py-2 border rounded",onClick:a,children:"取消"}),e.jsx("button",{"aria-label":"保存",type:"submit",disabled:j,className:"px-4 py-2 bg-blue-600 text-white rounded",children:j?"保存中...":"保存"})]})]})]})})}function H(){const[t,a]=b.useState(1),{data:c,isLoading:o}=f(t);console.log("活动列表数据:",c);const u=P(),n=M(),x=R(),[i,d]=b.useState(null);return e.jsxs(e.Fragment,{children:[e.jsx(Q,{position:"top-center"}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h2",{className:"text-3xl font-bold mb-4",children:"活动列表"}),e.jsx("button",{"aria-label":"新建",onClick:()=>d({mode:"create"}),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"新建"})]}),o?e.jsx("p",{children:"加载中..."}):c?.data?.length?e.jsxs("table",{className:"min-w-full border",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"border px-2 py-1",children:"ID"}),e.jsx("th",{className:"border px-2 py-1",children:"标题"}),e.jsx("th",{className:"border px-2 py-1",children:"开始时间"}),e.jsx("th",{className:"border px-2 py-1",children:"结束时间"}),e.jsx("th",{className:"border px-2 py-1",children:"人数上限"}),e.jsx("th",{className:"border px-2 py-1",children:"状态"}),e.jsx("th",{className:"border px-2 py-1",children:"操作"})]})}),e.jsx("tbody",{children:c.data.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"border px-2 py-1",children:s.id}),e.jsx("td",{className:"border px-2 py-1",children:s.title}),e.jsx("td",{className:"border px-2 py-1",children:new Date(s.startAt).toLocaleString()}),e.jsx("td",{className:"border px-2 py-1",children:s.endAt?new Date(s.endAt).toLocaleString():"-"}),e.jsx("td",{className:"border px-2 py-1",children:s.capacity}),e.jsx("td",{className:"border px-2 py-1",children:s.status}),e.jsxs("td",{className:"border px-2 py-1 flex gap-2",children:[e.jsx("button",{"aria-label":`编辑 ${s.title}`,onClick:()=>d({mode:"edit",id:s.id}),className:"text-blue-600 underline",children:"编辑"}),e.jsx("button",{"aria-label":`删除 ${s.title}`,onClick:()=>x.mutateAsync(s.id).then(()=>N.success("已删除")),className:"text-red-600 underline",children:"删除"})]})]},s.id))})]}):e.jsx("div",{className:"text-center py-10",children:e.jsx("p",{className:"text-gray-500 mb-4",children:"暂无活动，快去创建一个吧！"})}),i&&e.jsx(Y,{activityId:i.mode==="edit"?i.id:void 0,onClose:()=>d(null),onSubmit:async s=>{i.mode==="create"?await u.mutateAsync(s):await n.mutateAsync({id:i.id,data:s}),d(null),N.success("保存成功")}})]})]})}export{H as default};
